<!doctype html>
<html>
    <head>
        <meta charset="utf8" />
        <title>LibAVJS WebCodecs Bridge Example: Demuxer/decoder</title>
    </head>
    <body>
        <p>NOTE: This sample just demonstrates how to get and pass configurations. It is not efficient, and will freeze or fail on large files, as it does not stream data, but demuxes everything in one shot.</p>

        <script type="text/javascript">LibAV = {base: "https://unpkg.com/libav.js@4.3.6/dist"};</script>
        <script type="text/javascript" src="https://unpkg.com/libav.js@4.3.6/dist/libav-4.3.6.0-webcodecs.js"></script>

        <script type="text/javascript" src="../../libavjs-webcodecs-bridge.js"></script>

        <div id="demo-box">
            <label for="file">Input file:&nbsp;</label>
            <input type="file" id="file" />
        </div>

        <script type="text/javascript" src="../util.js"></script>

        <script type="text/javascript">
            sampleFileInput("file", (file, box) => {
                const worker = new Worker("decoder.js");
                let data = [];
                worker.onmessage = async ev => {
                    const cmd = ev.data;
                    if (cmd.c === "frame") {
                        // A frame of data
                        while (data.length <= cmd.idx)
                            data.push(null);
                        if (!data[cmd.idx]) {
                            data[cmd.idx] = {
                                a: !!cmd.a,
                                v: !!cmd.v,
                                frames: []
                            };
                        }
                        data[cmd.idx].frames.push(cmd.frame);

                    } else if (cmd.c === "done") {
                        // Received all data
                        for (const stream of data) {
                            if (!stream)
                                continue;
                            if (stream.v)
                                await sampleOutputVideo(stream.frames, 25);
                            else if (stream.a)
                                await sampleOutputAudio(stream.frames);
                        }

                    }
                };

                worker.postMessage(file);
            });
        </script>
    </body>
</html>
